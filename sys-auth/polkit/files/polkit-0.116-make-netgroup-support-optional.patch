From 6a46ff1b969a7109c6f5f25ebabaa943bbd5bdaf Mon Sep 17 00:00:00 2001
From: 
Date: Sun, 28 Apr 2019 16:46:26 -0500
Subject: [PATCH] make netgroup support optional

---
 configure.ac                                          | 2 +-
 src/polkitbackend/init.js                             | 5 ++++-
 src/polkitbackend/polkitbackendinteractiveauthority.c | 4 ++++
 src/polkitbackend/polkitbackendjsauthority.cpp        | 8 ++++++--
 test/polkitbackend/test-polkitbackendjsauthority.c    | 6 ++++--
 5 files changed, 19 insertions(+), 6 deletions(-)

diff --git a/configure.ac b/configure.ac
index 5cedb4e..88ce2a6 100644
--- a/configure.ac
+++ b/configure.ac
@@ -99,7 +99,7 @@ AC_CHECK_LIB(expat,XML_ParserCreate,[EXPAT_LIBS="-lexpat"],
 	     [AC_MSG_ERROR([Can't find expat library. Please install expat.])])
 AC_SUBST(EXPAT_LIBS)
 
-AC_CHECK_FUNCS(clearenv fdatasync)
+AC_CHECK_FUNCS(clearenv fdatasync getnetgrent)
 
 if test "x$GCC" = "xyes"; then
   LDFLAGS="-Wl,--as-needed $LDFLAGS"
diff --git a/src/polkitbackend/init.js b/src/polkitbackend/init.js
index 79c80b6..2065cff 100644
--- a/src/polkitbackend/init.js
+++ b/src/polkitbackend/init.js
@@ -29,7 +29,10 @@ function Subject() {
     };
 
     this.isInNetGroup = function(netGroup) {
-        return polkit._userIsInNetGroup(this.user, netGroup);
+        if (polkit._userIsInNetGroup)
+            return polkit._userIsInNetGroup(this.user, netGroup);
+        else
+            return false;
     };
 
     this.toString = function() {
diff --git a/src/polkitbackend/polkitbackendinteractiveauthority.c b/src/polkitbackend/polkitbackendinteractiveauthority.c
index 056d9a8..559cd06 100644
--- a/src/polkitbackend/polkitbackendinteractiveauthority.c
+++ b/src/polkitbackend/polkitbackendinteractiveauthority.c
@@ -2225,6 +2225,7 @@ get_users_in_group (PolkitIdentity                    *group,
   return ret;
 }
 
+#ifdef HAVE_GETNETGRENT
 static GList *
 get_users_in_net_group (PolkitIdentity                    *group,
                         gboolean                           include_root)
@@ -2284,6 +2285,7 @@ get_users_in_net_group (PolkitIdentity                    *group,
   endnetgrent ();
   return ret;
 }
+#endif
 
 /* ---------------------------------------------------------------------------------------------------- */
 
@@ -2369,10 +2371,12 @@ authentication_agent_initiate_challenge (AuthenticationAgent         *agent,
         {
           user_identities = g_list_concat (user_identities, get_users_in_group (identity, FALSE));
         }
+#ifdef HAVE_GETNETGRENT
       else if (POLKIT_IS_UNIX_NETGROUP (identity))
         {
           user_identities =  g_list_concat (user_identities, get_users_in_net_group (identity, FALSE));
         }
+#endif
       else
         {
           g_warning ("Unsupported identity");
diff --git a/src/polkitbackend/polkitbackendjsauthority.cpp b/src/polkitbackend/polkitbackendjsauthority.cpp
index 9b752d1..dcff711 100644
--- a/src/polkitbackend/polkitbackendjsauthority.cpp
+++ b/src/polkitbackend/polkitbackendjsauthority.cpp
@@ -192,13 +192,17 @@ static JSClass js_polkit_class = {
 
 static bool js_polkit_log (JSContext *cx, unsigned argc, JS::Value *vp);
 static bool js_polkit_spawn (JSContext *cx, unsigned argc, JS::Value *vp);
+#ifdef HAVE_GETNETGRENT
 static bool js_polkit_user_is_in_netgroup (JSContext *cx, unsigned argc, JS::Value *vp);
+#endif
 
 static JSFunctionSpec js_polkit_functions[] =
 {
   JS_FN("log",            js_polkit_log,            0, 0),
   JS_FN("spawn",          js_polkit_spawn,          0, 0),
+#ifdef HAVE_GETNETGRENT
   JS_FN("_userIsInNetGroup", js_polkit_user_is_in_netgroup,          0, 0),
+#endif
   JS_FS_END
 };
 
@@ -1488,7 +1492,7 @@ js_polkit_spawn (JSContext  *cx,
 
 /* ---------------------------------------------------------------------------------------------------- */
 
-
+#ifdef HAVE_GETNETGRENT
 static bool
 js_polkit_user_is_in_netgroup (JSContext  *cx,
                                unsigned    argc,
@@ -1526,7 +1530,7 @@ js_polkit_user_is_in_netgroup (JSContext  *cx,
 
   return ret;
 }
-
+#endif
 
 
 /* ---------------------------------------------------------------------------------------------------- */
diff --git a/test/polkitbackend/test-polkitbackendjsauthority.c b/test/polkitbackend/test-polkitbackendjsauthority.c
index 71aad23..2b2a5d4 100644
--- a/test/polkitbackend/test-polkitbackendjsauthority.c
+++ b/test/polkitbackend/test-polkitbackendjsauthority.c
@@ -137,12 +137,14 @@ test_get_admin_identities (void)
         "unix-group:users"
       }
     },
+#ifdef HAVE_GETNETGRENT
     {
       "net.company.action3",
       {
         "unix-netgroup:foo"
       }
     },
+#endif
   };
   guint n;
 
@@ -266,7 +268,7 @@ static const RulesTestCase rules_test_cases[] = {
     NULL,
     POLKIT_IMPLICIT_AUTHORIZATION_NOT_AUTHORIZED,
   },
-
+#if HAVE_GETNETGRENT
   /* check netgroup membership */
   {
     /* john is a member of netgroup 'foo', see test/etc/netgroup */
@@ -284,7 +286,7 @@ static const RulesTestCase rules_test_cases[] = {
     NULL,
     POLKIT_IMPLICIT_AUTHORIZATION_NOT_AUTHORIZED,
   },
-
+#endif
   /* spawning */
   {
     "spawning_non_existing_helper",
-- 
2.21.0

